name: Eiko
permissions:
  id-token: write
  contents: read
  checks: write
on:
    push:
    workflow_dispatch:
jobs:
    runner:
        runs-on: ubuntu-latest
        steps:
          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v3
          - name: Login to Docker Hub
            uses: docker/login-action@v3
            with:
              username: ${{ secrets.DOCKERHUB_USERNAME }}
              password: ${{ secrets.DOCKERHUB_ACCESSTOKEN }}
          - name: Build and push
            uses: docker/build-push-action@v6
            with:
              push: true
              file: "runner/Dockerfile"
              tags: eiko/github-runner:latest
    build:
        runs-on: ubuntu-latest
        container:
            image: eiko/github-runner:latest
            credentials:
                username: ${{ secrets.DOCKERHUB_USERNAME }}
                password: ${{ secrets.DOCKERHUB_ACCESSTOKEN }}
        steps:
            - name: Checkout
              uses: actions/checkout@v3
            - name: Build
              run: luarocks make --local
            - name: Test
              run: eval '$(luarocks path)' && chmod +x ./test/test.sh && luarocks test --local
            - name: Test Report
              uses: dorny/test-reporter@v1
              if: success() || failure()
              with:
                name: Lua tests
                path: reports/*.xml
                reporter: java-junit
                fail-on-error: 'false'
